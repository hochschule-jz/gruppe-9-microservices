name: CI/CD Pipeline - Build, Push, SBOM, Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ==========================================================
  # JOB 1: BACKEND SERVICES
  # ==========================================================
  build-and-scan-backend:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [api-gateway, discovery-service, booking-service, guest-service, room-service]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 1. Build the JARs
      - name: Build with Maven
        run: mvn clean package -DskipTests -pl ${{ matrix.service }} -am

      # 2. Log in to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      # 3. Build and Push Docker Image
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: |
            ${{ secrets.REGISTRY_USERNAME }}/${{ matrix.service }}:latest
            ${{ secrets.REGISTRY_USERNAME }}/${{ matrix.service }}:${{ github.sha }}

      # 4. Generate SBOM using Syft
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ secrets.REGISTRY_USERNAME }}/${{ matrix.service }}:latest
          format: spdx-json
          output-file: ${{ matrix.service }}-sbom.spdx.json

      # 5. Scan SBOM for Vulnerabilities using Grype
      - name: Scan SBOM
        uses: anchore/scan-action@v3
        id: scan
        with:
          sbom: ${{ matrix.service }}-sbom.spdx.json
          fail-build: false
          severity-cutoff: high

      - name: Upload Anchore Scan Report
        uses: github/codeql-action/upload-sarif@v4
        with:
            sarif_file: ${{ steps.scan.outputs.sarif }}

      # Optional: Upload SBOM as artifact to inspect later
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.service }}
          path: ${{ matrix.service }}-sbom.spdx.json

  # ==========================================================
  # JOB 2: FRONTEND
  # ==========================================================
  build-and-scan-ui:
    runs-on: ubuntu-latest
    needs: build-and-scan-backend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      # 1. Build and Push
      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./booking-ui
          push: true
          tags: |
            ${{ secrets.REGISTRY_USERNAME }}/booking-ui:latest
            ${{ secrets.REGISTRY_USERNAME }}/booking-ui:${{ github.sha }}

      # 2. Generate SBOM
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ secrets.REGISTRY_USERNAME }}/booking-ui:latest
          format: spdx-json
          output-file: ui-sbom.spdx.json

      # 3. Scan SBOM
      - name: Scan SBOM
        uses: anchore/scan-action@v3
        with:
          sbom: ui-sbom.spdx.json
          fail-build: false
          severity-cutoff: high